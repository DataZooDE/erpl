# name: test/sql/sap_read_table.test
# description: test the functionality read a full SAP table
# group: [rfc]

# Require RFC the extension
require erpl_rfc

# Configure connection ------------------------------------------------
require-env ERPL_SAP_ASHOST

require-env ERPL_SAP_SYSNR

require-env ERPL_SAP_USER

require-env ERPL_SAP_PASSWORD

require-env ERPL_SAP_CLIENT

require-env ERPL_SAP_LANG

statement ok
CREATE SECRET abap_trial (
    TYPE sap_rfc, 
    ASHOST '${ERPL_SAP_ASHOST}', 
    SYSNR '${ERPL_SAP_SYSNR}', 
    CLIENT '${ERPL_SAP_CLIENT}', 
    USER '${ERPL_SAP_USER}', 
    PASSWD '${ERPL_SAP_PASSWORD}',
    LANG '${ERPL_SAP_LANG}'
);
# ---------------------------------------------------------------------
# Confirm I retrieve the correct row count
query I
SELECT COUNT(*) FROM sap_read_table('/DMO/FLIGHT');
----
40

# ---------------------------------------------------------------------
# Confirm I retrieve the correct table data
query II
SELECT CARRIER_ID, CONNECTION_ID FROM sap_read_table('/DMO/FLIGHT') ORDER BY 1, 2 LIMIT 10;
----
AA
0015
AA
0015
AA
0017
AA
0017
AA
0018
AA
0018
AA
0322
AA
0322
AA
2678
AA
2678

# ---------------------------------------------------------------------
# If we limit the number we should get this value exactly as count
query I
SELECT CARRIER_ID FROM sap_read_table('/DMO/FLIGHT', columns=['CARRIER_ID'], threads=1, max_rows=8);
----
AA
AA
AA
AA
AA
AA
AA
AA

# ---------------------------------------------------------------------
# If we select a column that we don't have in the columns list, we should get a bind error
statement error
SELECT PRICE FROM sap_read_table('/DMO/FLIGHT', columns=['CARRIER_ID', 'CONNECTION_ID']);
----
Binder Error: Referenced column "PRICE" not found in FROM clause!

# ---------------------------------------------------------------------
# Confirm where as named param works
query I
SELECT COUNT(*) FROM sap_read_table('/DMO/FLIGHT', FILTER='CARRIER_ID = ''SQ'' AND CONNECTION_ID = ''0001''');
----
2

# ---------------------------------------------------------------------
# Confirm that filter pushdown works (for the simply type of expressions DuckDB supports)
query I
SELECT COUNT(*) FROM sap_read_table('/DMO/FLIGHT') WHERE CARRIER_ID = 'SQ' AND CONNECTION_ID = '0001';
----
2

# ---------------------------------------------------------------------
# Confirm that a combination of filter pushdown and named param works
query I
SELECT COUNT(*) FROM sap_read_table('/DMO/FLIGHT', FILTER='CARRIER_ID = ''SQ''') WHERE CONNECTION_ID = '0001';
----
2

# Confirm that we can join two tables (enable tracing just for this block)
statement ok
SET erpl_trace_output='console';

statement ok
SET erpl_trace_level='DEBUG';

statement ok
SET erpl_trace_enabled=true;

query I
SELECT COUNT(*)
FROM sap_read_table('SFLIGHT') AS f
JOIN sap_read_table('SPFLI') AS s 
    ON (f.MANDT = s.MANDT AND f.CARRID = s.CARRID AND f.CONNID = s.CONNID);
----
94

statement ok
SET erpl_trace_enabled=false;

# ---------------------------------------------------------------------
# CDS View: sap_read_table should handle CDS views with NODE-type entries
# (Issue #42: "Unsupported SAP table type name: NODE")
query I
SELECT COUNT(*) >= 0 FROM sap_read_table('/DMO/R_Booking_D');
----
1

# ---------------------------------------------------------------------
# CDS View: explicit column selection should work
query I
SELECT COUNT(*) >= 0 FROM sap_read_table('/DMO/R_Booking_D', COLUMNS=['BOOKINGID']);
----
1

# =====================================================================
# Additional data type coverage (Flight Reference Scenario tables)
# =====================================================================

# ---------------------------------------------------------------------
# /DMO/TRAVEL: covers CURR, CUKY, DEC, DATS, NUMC, CHAR
query I
SELECT COUNT(*) >= 0 FROM sap_read_table('/DMO/TRAVEL');
----
1

# /DMO/TRAVEL: explicit fixed-length column selection
query I
SELECT COUNT(*) >= 0 FROM sap_read_table('/DMO/TRAVEL', COLUMNS=['TRAVEL_ID', 'TOTAL_PRICE', 'CURRENCY_CODE', 'BEGIN_DATE']);
----
1

# /DMO/TRAVEL: SSTR column via ET_DATA (SAP Note 2246160)
query I
SELECT COUNT(*) >= 0 FROM sap_read_table('/DMO/TRAVEL', COLUMNS=['DESCRIPTION'], READ_TABLE_FUNCTION='RFC_READ_TABLE', READ_TABLE_DELIMITER='~');
----
1

# /DMO/TRAVEL: mixed string + fixed-length columns
query I
SELECT COUNT(*) >= 0 FROM sap_read_table('/DMO/TRAVEL', COLUMNS=['TRAVEL_ID', 'DESCRIPTION', 'BEGIN_DATE'], READ_TABLE_FUNCTION='RFC_READ_TABLE', READ_TABLE_DELIMITER='~');
----
1

# ---------------------------------------------------------------------
# /DMO/AGENCY: contains STRG (EMAIL_ADDRESS, WEB_ADDRESS) and RSTR (ATTACHMENT)
query I
SELECT COUNT(*) >= 0 FROM sap_read_table('/DMO/AGENCY');
----
1

# /DMO/AGENCY: explicit fixed-length column selection
query I
SELECT COUNT(*) >= 0 FROM sap_read_table('/DMO/AGENCY', COLUMNS=['AGENCY_ID', 'NAME', 'CITY']);
----
1

# /DMO/AGENCY: STRG column via ET_DATA (SAP Note 2246160)
query I
SELECT COUNT(*) >= 0 FROM sap_read_table('/DMO/AGENCY', COLUMNS=['EMAIL_ADDRESS'], READ_TABLE_FUNCTION='RFC_READ_TABLE', READ_TABLE_DELIMITER='~');
----
1

# ---------------------------------------------------------------------
# T002: covers LANG type via SPRAS (language key, fixed 1-byte)
query I
SELECT COUNT(*) > 0 FROM sap_read_table('T002');
----
1

# T002: read LANG-typed column explicitly
query I
SELECT COUNT(*) > 0 FROM sap_read_table('T002', COLUMNS=['SPRAS']);
----
1

# ---------------------------------------------------------------------
# Verify supported READ_TABLE_FUNCTION values
query I
SELECT COUNT(*) >= 0 FROM sap_read_table('/DMO/FLIGHT', COLUMNS=['CARRIER_ID'], READ_TABLE_FUNCTION='RFC_READ_TABLE');
----
1

query I
SELECT COUNT(*) >= 0 FROM sap_read_table('/DMO/FLIGHT', COLUMNS=['CARRIER_ID'], READ_TABLE_FUNCTION='/BODS/RFC_READ_TABLE');
----
1

query I
SELECT COUNT(*) >= 0 FROM sap_read_table('/DMO/FLIGHT', COLUMNS=['CARRIER_ID'], READ_TABLE_FUNCTION='/SAPDS/RFC_READ_TABLE');
----
1

query I
SELECT COUNT(*) >= 0 FROM sap_read_table('/DMO/FLIGHT', COLUMNS=['CARRIER_ID'], READ_TABLE_FUNCTION='/BODS/RFC_READ_TABLE2', READ_TABLE_DELIMITER='~');
----
1

query I
SELECT COUNT(*) >= 0 FROM sap_read_table('/DMO/FLIGHT', COLUMNS=['CARRIER_ID'], READ_TABLE_FUNCTION='/SAPDS/RFC_READ_TABLE2', READ_TABLE_DELIMITER='~');
----
1
